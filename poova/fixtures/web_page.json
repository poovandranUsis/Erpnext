[
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 1,
  "dynamic_template": 1,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!-- Load FullCalendar CSS -->\r\n<link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css\" rel=\"stylesheet\">\r\n\r\n<!-- Load FullCalendar JS -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js\"></script>\r\n\r\n<div class=\"row\">\r\n    <!-- Jobs List Section -->\r\n    <div class=\"col-md-3\">\r\n        <h3>Jobs</h3>\r\n        <ul id=\"job-list\" class=\"list-group mt-2\"></ul>\r\n    </div>\r\n\r\n    <!-- Calendar Section -->\r\n    <div class=\"col-md-6\">\r\n        <div id=\"calendar\"></div>\r\n    </div>\r\n\r\n    <!-- Vehicle and User List Section -->\r\n    <div class=\"col-md-3\">\r\n        <h3>Vehicle</h3>\r\n        <ul id=\"vehicle-list\" class=\"list-group mt-2\"></ul>\r\n        <h3>Technicians</h3>\r\n        <ul id=\"user-list\" class=\"list-group mt-2\"></ul>\r\n    </div>\r\n</div>\r\n<style>\r\n    html, body {\r\n  margin: 0;\r\n  padding: 0;\r\n  font-family: Arial, Helvetica Neue, Helvetica, sans-serif;\r\n  font-size: 14px;\r\n}\r\n\r\n#calendar {\r\n  max-width: 800px;\r\n  margin: 40px auto;\r\n}\r\n#job-list, #vehicle-list, #user-list {\r\n    height: 30vh;\r\n    overflow-y: scroll;\r\n    scrollbar-width: none;\r\n    list-style-type: none;\r\n    padding-left: 0;\r\n}\r\n#job-list{height:60vh!important}\r\n.web-footer{display:none}\r\n\r\n.sortable-ghost { opacity: 0.4; }\r\n.fc-event { cursor: pointer; }\r\n</style>\r\n<script>\r\n document.addEventListener('DOMContentLoaded', function() {\r\n frappe.ready(function () {\r\n        var calendarEl = document.getElementById(\"calendar\");\r\n        var jobListEl = document.getElementById(\"job-list\");\r\n        var vehicleListEl = document.getElementById(\"vehicle-list\");\r\n        var userListEl = document.getElementById(\"user-list\");\r\n        let isUpdatingEvent = false; \r\n        let Create=false;\r\n           const images = {\r\n          jobicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABtUlEQVR4Aa1Wi3GDMAw1vQzABvEIjMAGZYNkg9AJwgZhA7pBukFGoBvQTuBuoErJc1Acm7i56k6HbX2efhgKk0FE1PDjVR39FEXxlmP7YvKoYm6wtswtg67NM8SGO+HgbGD+wNrShWolt9Cxj5zvaSZZS6Qn7HvolEpHnG6ZJ+ynJIhy3jFXysiF0cHpqIDeYTMmQVSkpUp76/eJoGoMgN+38NHElC3Qx4hsg0ymqPFsLzqdWYhoQARVcN6gDJ42EVsvXy8BSIST2peBvEuBoJx0lwGaI7U8QKFVUZ8SQXiqA5kD12DrDwmGJ8IE0Nz0jXJg6ZaGAKCFH3eVR9MyNxNBWNdB9NdsE+U+j/cqpcB3TY8e7JkPCbXkCIdIvkQjLTc2RrqEu1iJLNLvFsqVBcLPIwAa+Cxj2TiKvL2kJoNu34krCGTVUrl6KD+8ilMgSwb+quhMJv0JhC4Ndmov5ZDxtP8CQvPc71FPTQPdX9dH1dxsED0tPc1v5hkEOv6DI8PQPptJGymDB6hgXGWUy5kcQmYOZfFfsnVCV4N0K5NH8sH3Dj+F+Sr5jinyufTny1x+bfpffZT/wwL3joQAAAAASUVORK5CYII=\",\r\n          techniciansicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAPCAYAAAD+pA/bAAAAyElEQVR4AbWSDQ3CMBCFr1MwHNQBlVAJSMABOGAOkIAEJFQCOBgONhSUu+RK1nJ0TTi+5KU/ad/rNQfQQIzxHHOOoAkajkVAaL3bVUw9ag/14MPaGemSpRfySydUL1XA5xJXWreal2bDl4BLsTeuhghGqYpJMJO41cxPUYdh6WuWr8fBwu/MxphNWnRs7pXMCWoKlwUgDnT5COhBF/ueYTk7oUs08CkgxP8Q0hdpf0/2TYarcLxB45ZDS5XMLOLBeqLuJGxVGuEFaLkGQweqVP8AAAAASUVORK5CYII=\",\r\n          vechicleicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAUCAYAAACXtf2DAAABFElEQVR4Ad1U2w3CMAx0EAN0hIwAG8AGjMAGiAmACRATwAawAWxAmaBlgrJBuKiOsIJpEWl/OOkaNXZ8dh421ALn3ALDjH5Dbto8IOAoAQPqGUNtEklbDJb6AIIfXYcYRsH3VB9ozvSYUxfwwVn0CmZiPgkhyFYL3oWACUEwlODYGPOIBSgBhjOu+L9UfCylCPhPapZN6P2h/YEAtl/rlBdwR/qha3iwf/5mgUARXd29sE3cd7BizVkafKuYgiOqr+MWvAdnvIkLXzCf2VLJ3CeTwa8UczdwAm7Ak6wkY9EiZIRxFVcVVR8a44r/rXvtSKYtWIvqqlhQ8bfCrxJr1/QJMM5d3ZMKztBSA1jkwP5nv17an7vv+u5j7kK5AAAAAElFTkSuQmCC\"\r\n     };\r\n\r\n        // Initialize the FullCalendar instance\r\n        var calendar = new FullCalendar.Calendar(calendarEl, {\r\n            initialView: \"timeGridDay\",\r\n            headerToolbar: {\r\n                left: \"prev,next today\",\r\n                center: \"title\",\r\n                right: \"dayGridMonth,timeGridWeek,timeGridDay\"\r\n            },\r\n            dayMaxEvents: true,\r\n            editable: true,\r\n            droppable: true,\r\n            eventContent: function (arg) {\r\n                    if (arg.event.extendedProps.customTitle) {\r\n                        return { html: arg.event.extendedProps.customTitle };\r\n                    }\r\n                },\r\n\r\n            // Event handler for when a job is dragged and dropped onto the calendar\r\n     eventReceive: function(info) {\r\n    let jobId = info.event.id;\r\n    let jobTitle = info.event.title;\r\n    let startDate = info.event.start;\r\n    let endDate = new Date(startDate);\r\n    endDate.setHours(startDate.getHours() + 1);\r\n\r\n    console.log(\"Event Dropped:\", { jobId, jobTitle, startDate, endDate });\r\n\r\n    frappe.call({\r\n        method: \"frappe.poc.api.insert_testingcal_event\",\r\n        args: {\r\n            job_id: info.event.id,\r\n            job_title: info.event.title,\r\n            start_date: info.event.start.toISOString(),\r\n        },\r\n        callback: function(response) {\r\n            if (response.message) {\r\n                let e = response.message;\r\n                Create=true;\r\n                console.log(\"Frappe Response:\", e);\r\n                       info.event.setProp('id', e.name);\r\n            }\r\n        },\r\n        error: function(error) {\r\n            console.error(\"Error inserting event:\", error);\r\n        }\r\n    });\r\n},\r\n\r\n\r\neventChange: function (info) {\r\n    if (isUpdatingEvent) {\r\n        // Skip if an update is already in progress to prevent infinite loop\r\n        return;\r\n    }\r\n\r\n    let updatedStartDate = info.event.start;\r\n    let updatedEndDate = info.event.end;\r\n\r\n    // Ensure event has an ID\r\n    if (!info.event.id) {\r\n        console.error(\"Event ID is missing.\");\r\n        return;\r\n    }\r\n\r\n    isUpdatingEvent = true; // Set flag to indicate an update is in progress\r\n    // Fetch the latest document before updating\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"testingcal\",\r\n            name: info.event.id\r\n        },\r\n        callback: async function (docResponse) {\r\n            if (!docResponse.message) {\r\n                console.error(\"Failed to fetch event data.\");\r\n                isUpdatingEvent = false;\r\n                return;\r\n            }\r\n            if(Create){\r\n            let newJobTitleHtml = \"\";\r\n\r\n           \r\n                let startTime = new Date(updatedStartDate);\r\n                let endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // Add 1 hour\r\n                \r\n                // Format the times\r\n                startTime = startTime.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n                endTime = endTime.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n\r\n                // Fetch product name from SalesPoc\r\n                const getproduct_name = docResponse.message.title ? await gettitle(docResponse.message.title) : \"Unknown Product\";\r\n\r\n                // Fetch full names for technicians\r\n                const technicianNames = docResponse.message.technicians\r\n                    ? await Promise.all(docResponse.message.technicians.map(tech => getUserFullName(tech.user)))\r\n                    : [];\r\n\r\n                // Fetch vehicle names\r\n                const vehicleNames = docResponse.message.vehicles\r\n                    ? await Promise.all(docResponse.message.vehicles.map(vehi => getVehicleName(vehi.vehicle)))\r\n                    : [];\r\n\r\n                // Construct job title with time and details\r\n                newJobTitleHtml = `\r\n                    <div>\r\n                        <strong>${startTime} - ${endTime}</strong><br>\r\n                        <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                        ${technicianNames.length ? `<img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>` : \"\"}\r\n                        ${vehicleNames.length ? `<img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>` : \"\"}\r\n                    </div>\r\n                `;\r\n\r\n                // Update event UI, and ensure this doesn't trigger another eventChange\r\n                info.event.setExtendedProp(\"customTitle\", newJobTitleHtml);\r\n                if(Create){\r\n                 isUpdatingEvent = false;\r\n                 Create=false;\r\n                 return;\r\n                }\r\n            }\r\n       \r\n\r\n            let doc = docResponse.message; // Latest document\r\n\r\n            // Update fields\r\n            doc.startdate = formatDateForMySQL(updatedStartDate);\r\n            doc.end_date = formatDateForMySQL(updatedEndDate);\r\n\r\n            // Save the updated document\r\n            frappe.call({\r\n                method: \"frappe.client.save\",\r\n                args: {\r\n                    doc: doc\r\n                },\r\n                callback: async function (saveResponse) {\r\n                    if (!saveResponse.message) {\r\n                        console.error(\"Failed to save updated event.\");\r\n                        isUpdatingEvent = false;\r\n                        return;\r\n                    }\r\n\r\n                    console.log(\"Updated Event:\", saveResponse.message);\r\n\r\n                    let newJobTitleHtml = \"\";\r\n\r\n                    // Format time (Start - End)\r\n                    let startTime = new Date(doc.startdate).toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n                    let endTime = new Date(doc.end_date).toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n\r\n                    // Fetch product name from SalesPoc\r\n                    const getproduct_name = doc.title ? await gettitle(doc.title) : \"Unknown Product\";\r\n\r\n                    // Fetch full names for technicians\r\n                    const technicianNames = doc.technicians\r\n                        ? await Promise.all(doc.technicians.map(tech => getUserFullName(tech.user)))\r\n                        : [];\r\n\r\n                    // Fetch vehicle names\r\n                    const vehicleNames = doc.vehicles\r\n                        ? await Promise.all(doc.vehicles.map(vehi => getVehicleName(vehi.vehicle)))\r\n                        : [];\r\n\r\n                    // Construct job title with time and details\r\n                    newJobTitleHtml = `\r\n                        <div>\r\n                            <strong>${startTime} - ${endTime}</strong><br>\r\n                            <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                            ${technicianNames.length ? `<img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>` : \"\"}\r\n                            ${vehicleNames.length ? `<img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>` : \"\"}\r\n                        </div>\r\n                    `;\r\n\r\n                    // Update event UI, and ensure this doesn't trigger another eventChange\r\n                    info.event.setExtendedProp(\"customTitle\", newJobTitleHtml);\r\n\r\n                    console.log(\"Event Updated Successfully!\");\r\n\r\n                    // Reset the flag after update\r\n                    isUpdatingEvent = false;\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n},\r\n\r\n    eventClick: function(info) {\r\n        if (info.event.id) {\r\n             window.open(\"http://localhost:8081/app/testingcal/\" + info.event.id, \"_blank\");// Redirect to event details page\r\n         console.log(info.event.id);\r\n         \r\n                         }\r\n           },\r\n            eventRender: function(info) {\r\n            info.el.setAttribute(\"data-id\", info.event.id);\r\n            }\r\n    \r\n        });\r\n  \r\n        // Render the calendar\r\n        calendar.render();\r\n        \r\n        \r\n\r\n        // Fetch and populate the list of jobs\r\n        function fetchJobs() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"SalesPoc\",\r\n                    filters: { status: \"Accepted\" },\r\n                    fields: [\"name\", \"product_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let jobs = response.message || [];\r\n                    jobListEl.innerHTML = jobs.map(job =>\r\n                        `<li class=\"list-group-item job-item\" data-id=\"${job.name}\" draggable=\"true\">${job.product_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch and populate the list of vehicles\r\n        function fetchVehicles() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Vehicles\",\r\n                    fields: [\"name\", \"vehicle_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let vehicles = response.message || [];\r\n                    vehicleListEl.innerHTML = vehicles.map(v =>\r\n                        `<li class=\"list-group-item vehicle-item\" data-id=\"${v.name}\" draggable=\"true\">${v.vehicle_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch and populate the list of users\r\n        function fetchUsers() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"User\",\r\n                    filters: { role_profile_name: \"EnigneerPOC\" }, // Note: There's a typo here, \"Enigneer\" should be \"Engineer\"\r\n                    fields: [\"name\", \"full_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let users = response.message || [];\r\n                    userListEl.innerHTML = users.map(u =>\r\n                        `<li class=\"list-group-item user-item\" data-id=\"${u.name}\" draggable=\"true\">${u.full_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch existing events from the calendar and display them\r\nfunction fetchCalendarEvents() {\r\n    frappe.call({\r\n        method: \"frappe.poc.api.get_testingcal_events\",\r\n        callback: async function (response) {\r\n            let events = response.message ? response.message.map(e => {\r\n                let startTime = new Date(e.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                let endTime = new Date(e.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                let newJobTitleHtml = `<div>${startTime} - ${endTime}<br>`;  // Show time at top\r\n                    newJobTitleHtml +=  `<div><img src=\"${images.jobicon}\" width=\"15\"> ${e.product_name || e.name}<br>`;\r\n\r\n                if (e.technicians.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.techniciansicon}\" width=\"15\"> ${e.technicians.join(\", \")}<br>`;\r\n                }\r\n                if (e.vehicles.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.vechicleicon}\" width=\"15\"> ${e.vehicles.join(\", \")}<br>`;\r\n                }\r\n\r\n                newJobTitleHtml += `</div>`;\r\n\r\n                return {\r\n                    id: e.name,\r\n                    title: e.jobtitle,\r\n                    start: e.startdate,\r\n                    end: e.end_date,\r\n                    extendedProps: { customTitle: newJobTitleHtml }\r\n                };\r\n            }) : [];\r\n\r\n            calendar.removeAllEvents();\r\n            calendar.addEventSource(events);\r\n            console.log(events);\r\n        }\r\n    });\r\n}\r\nasync function getUserFullName(userId) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"User\",\r\n                filters: { name: userId },\r\n                fieldname: \"full_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.full_name || \"Unknown User\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\nasync function gettitle(title) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"SalesPoc\",\r\n                filters: { name: title },\r\n                fieldname: \"product_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.product_name || \"Unknown product\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\n// Function to fetch vehicle name\r\nasync function getVehicleName(vehicleId) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"Vehicles\",\r\n                filters: { name: vehicleId },\r\n                fieldname: \"vehicle_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.vehicle_name || \"Unknown Vehicle\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\n        // Function to make list items (jobs, users, vehicles) draggable\r\n        function makeDraggable() {\r\n            new FullCalendar.Draggable(jobListEl, {\r\n                itemSelector: \".job-item\",\r\n                eventData: function (eventEl) {\r\n                    return { id: eventEl.getAttribute(\"data-id\"), title: eventEl.innerText };\r\n                }\r\n            });\r\n\r\n            // Set up drag-and-drop for users\r\n            document.getElementById(\"user-list\").addEventListener(\"dragstart\", function (event) {\r\n                event.dataTransfer.setData(\"text/plain\", JSON.stringify({\r\n                    id: event.target.getAttribute(\"data-id\"),\r\n                    name: event.target.innerText,\r\n                    type: \"assigned\"  // Assigning user data\r\n                }));\r\n            });\r\n\r\n            // Set up drag-and-drop for vehicles\r\n            document.getElementById(\"vehicle-list\").addEventListener(\"dragstart\", function (event) {\r\n                event.dataTransfer.setData(\"text/plain\", JSON.stringify({\r\n                    id: event.target.getAttribute(\"data-id\"),\r\n                    name: event.target.innerText,\r\n                    type: \"vehicle\"  // Assigning vehicle data\r\n                }));\r\n            });\r\n            \r\n\r\n            // Allow drag over the calendar (enabling drop)\r\n            calendarEl.addEventListener(\"dragover\", function (event) {\r\n                event.preventDefault();\r\n            });\r\n\r\n        }\r\n          \r\n    document.getElementById(\"calendar\").addEventListener(\"drop\", async function (event) {\r\n    event.preventDefault();\r\n\r\n    let GetUserorvehicleData = JSON.parse(event.dataTransfer.getData(\"text/plain\")),\r\n        jobElement = document.elementFromPoint(event.clientX, event.clientY)?.closest(\".fc-event\");\r\n\r\n    if (!jobElement) return;\r\n\r\n    let jobId = jobElement.getAttribute(\"data-id\") || jobElement.fcSeg.eventRange.def.publicId,\r\n        calendarEvent = calendar.getEventById(jobId),\r\n        JobOriginalContent = jobElement.fcSeg.eventRange.def.extendedProps.JobTitle,\r\n        currentTitle = calendarEvent ? calendarEvent.title : JobOriginalContent,\r\n        newJobTitle = `${currentTitle} ${GetUserorvehicleData.name}`;\r\n\r\n    // Determine fields dynamically\r\n    let isVehicle = GetUserorvehicleData.type === \"vehicle\",\r\n        fieldName = isVehicle ? \"vehicles\" : \"technicians\",\r\n        singleField = isVehicle ? \"vehicle\" : \"assigned\",\r\n        childDocType = isVehicle ? \"childdoc\" : \"Userchild\",\r\n        userField = isVehicle ? \"vehicle\" : \"user\"; // Fix: Vehicles should store \"vehicle\"\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: { doctype: \"testingcal\", name: jobId },\r\n        callback: async function (response) {\r\n            if (!response.message) return;\r\n\r\n            let existingEntries = response.message[fieldName] || [];\r\n            if (existingEntries.some(e => e[userField] === GetUserorvehicleData.id)) {\r\n                return frappe.msgprint(`${GetUserorvehicleData.type} already assigned!`);\r\n            }\r\n\r\n            existingEntries.push({ \"doctype\": childDocType, [userField]: GetUserorvehicleData.id });\r\n\r\n            // Update the job in the database with the new job title, user/vehicle assignment, and other necessary fields\r\n            frappe.call({\r\n                method: \"frappe.client.set_value\",\r\n                args: {\r\n                    doctype: \"testingcal\",\r\n                    name: jobId,\r\n                    fieldname: {\r\n                        [singleField]: GetUserorvehicleData.id,\r\n                        [fieldName]: existingEntries,\r\n                        jobtitle: newJobTitle // Update the title in the database\r\n                    }\r\n                },\r\n                callback: async function (response) {\r\n                    console.log(`Updated Job with ${GetUserorvehicleData.type}:`, response.message);\r\n\r\n                    let newJobTitleHtml = \"\";\r\n                    \r\n                    // Format time (Start - End)\r\n                    let startTime = new Date(response.message.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                    let endTime = new Date(response.message.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                    \r\n                    // Fetch full names for technicians\r\n                    const technicianNames = await Promise.all(\r\n                        response.message.technicians.map(tech => getUserFullName(tech.user))\r\n                    );\r\n                    \r\n                    const getproduct_name = await gettitle(response.message.title);\r\n                    // Fetch vehicle names\r\n                    const vehicleNames = await Promise.all(\r\n                        response.message.vehicles.map(vehi => getVehicleName(vehi.vehicle))\r\n                    );\r\n                    \r\n                    // Construct job title with time and details\r\n                    if (technicianNames.length !== 0 && vehicleNames.length !== 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>\r\n                                <img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    else if (technicianNames.length !== 0 && vehicleNames.length == 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    else if (vehicleNames.length !== 0 && technicianNames.length == 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    \r\n                    frappe.msgprint(`${GetUserorvehicleData.type} Added: ${GetUserorvehicleData.name}`);\r\n                    \r\n                    // Store updated job details with time in `extendedProps`\r\n                    calendarEvent?.setExtendedProp('customTitle', newJobTitleHtml);\r\n\r\n                }\r\n            });\r\n        }\r\n    });\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n        //Date and time formating\r\n          function formatDateForMySQL(date) {\r\n                    return date.getFullYear() + \"-\" +\r\n                        (\"0\" + (date.getMonth() + 1)).slice(-2) + \"-\" +\r\n                        (\"0\" + date.getDate()).slice(-2) + \" \" +\r\n                        (\"0\" + date.getHours()).slice(-2) + \":\" +\r\n                        (\"0\" + date.getMinutes()).slice(-2) + \":\" +\r\n                        (\"0\" + date.getSeconds()).slice(-2);\r\n                }\r\n\r\n        // Initialize everything by fetching data and making elements draggable\r\n        fetchJobs();\r\n        fetchVehicles();\r\n        fetchUsers();\r\n        fetchCalendarEvents();\r\n        makeDraggable();\r\n    });\r\n });\r\n</script>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 12:06:10.959688",
  "module": "Poova",
  "name": "testingpage",
  "page_blocks": [
   {
    "add_background_image": 0,
    "add_border_at_bottom": 0,
    "add_border_at_top": 0,
    "add_bottom_padding": 1,
    "add_container": 1,
    "add_shade": 0,
    "add_top_padding": 1,
    "background_image": null,
    "css_class": null,
    "hide_block": 0,
    "parent": "testingpage",
    "parentfield": "page_blocks",
    "parenttype": "Web Page",
    "section_id": null,
    "web_template": "Section with Cards",
    "web_template_values": "{\"title\":\"testing\",\"card_size\":\"Small\",\"card_1_title\":\"card 1\",\"card_1_content\":\"Card1 content\"}"
   }
  ],
  "published": 1,
  "route": "testingpage",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "testingpage",
  "website_sidebar": null
 },
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 1,
  "dynamic_template": 1,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!-- Load FullCalendar CSS -->\r\n<link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css\" rel=\"stylesheet\">\r\n\r\n<!-- Load FullCalendar JS -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js\"></script>\r\n\r\n<div class=\"row\">\r\n    <!-- Jobs List Section -->\r\n    <div class=\"col-md-3\">\r\n        <h3>Jobs</h3>\r\n        <ul id=\"job-list\" class=\"list-group mt-2\"></ul>\r\n    </div>\r\n\r\n    <!-- Calendar Section -->\r\n    <div class=\"col-md-6\">\r\n        <div id=\"calendar\"></div>\r\n    </div>\r\n\r\n    <!-- Vehicle and User List Section -->\r\n    <div class=\"col-md-3\">\r\n        <h3>Vehicle</h3>\r\n        <ul id=\"vehicle-list\" class=\"list-group mt-2\"></ul>\r\n        <h3>Technicians</h3>\r\n        <ul id=\"user-list\" class=\"list-group mt-2\"></ul>\r\n    </div>\r\n</div>\r\n<style>\r\n    html, body {\r\n  margin: 0;\r\n  padding: 0;\r\n  font-family: Arial, Helvetica Neue, Helvetica, sans-serif;\r\n  font-size: 14px;\r\n}\r\n\r\n#calendar {\r\n  max-width: 800px;\r\n  margin: 40px auto;\r\n}\r\n#job-list, #vehicle-list, #user-list {\r\n    height: 30vh;\r\n    overflow-y: scroll;\r\n    scrollbar-width: none;\r\n    list-style-type: none;\r\n    padding-left: 0;\r\n}\r\n#job-list{height:60vh!important}\r\n.web-footer{display:none}\r\n\r\n.sortable-ghost { opacity: 0.4; }\r\n.fc-event { cursor: pointer; }\r\n</style>\r\n<script>\r\n document.addEventListener('DOMContentLoaded', function() {\r\n frappe.ready(function () {\r\n        var calendarEl = document.getElementById(\"calendar\");\r\n        var jobListEl = document.getElementById(\"job-list\");\r\n        var vehicleListEl = document.getElementById(\"vehicle-list\");\r\n        var userListEl = document.getElementById(\"user-list\");\r\n        let isUpdatingEvent = false; \r\n        let Create=false;\r\n           const images = {\r\n          jobicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABtUlEQVR4Aa1Wi3GDMAw1vQzABvEIjMAGZYNkg9AJwgZhA7pBukFGoBvQTuBuoErJc1Acm7i56k6HbX2efhgKk0FE1PDjVR39FEXxlmP7YvKoYm6wtswtg67NM8SGO+HgbGD+wNrShWolt9Cxj5zvaSZZS6Qn7HvolEpHnG6ZJ+ynJIhy3jFXysiF0cHpqIDeYTMmQVSkpUp76/eJoGoMgN+38NHElC3Qx4hsg0ymqPFsLzqdWYhoQARVcN6gDJ42EVsvXy8BSIST2peBvEuBoJx0lwGaI7U8QKFVUZ8SQXiqA5kD12DrDwmGJ8IE0Nz0jXJg6ZaGAKCFH3eVR9MyNxNBWNdB9NdsE+U+j/cqpcB3TY8e7JkPCbXkCIdIvkQjLTc2RrqEu1iJLNLvFsqVBcLPIwAa+Cxj2TiKvL2kJoNu34krCGTVUrl6KD+8ilMgSwb+quhMJv0JhC4Ndmov5ZDxtP8CQvPc71FPTQPdX9dH1dxsED0tPc1v5hkEOv6DI8PQPptJGymDB6hgXGWUy5kcQmYOZfFfsnVCV4N0K5NH8sH3Dj+F+Sr5jinyufTny1x+bfpffZT/wwL3joQAAAAASUVORK5CYII=\",\r\n          techniciansicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAPCAYAAAD+pA/bAAAAyElEQVR4AbWSDQ3CMBCFr1MwHNQBlVAJSMABOGAOkIAEJFQCOBgONhSUu+RK1nJ0TTi+5KU/ad/rNQfQQIzxHHOOoAkajkVAaL3bVUw9ag/14MPaGemSpRfySydUL1XA5xJXWreal2bDl4BLsTeuhghGqYpJMJO41cxPUYdh6WuWr8fBwu/MxphNWnRs7pXMCWoKlwUgDnT5COhBF/ueYTk7oUs08CkgxP8Q0hdpf0/2TYarcLxB45ZDS5XMLOLBeqLuJGxVGuEFaLkGQweqVP8AAAAASUVORK5CYII=\",\r\n          vechicleicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAUCAYAAACXtf2DAAABFElEQVR4Ad1U2w3CMAx0EAN0hIwAG8AGjMAGiAmACRATwAawAWxAmaBlgrJBuKiOsIJpEWl/OOkaNXZ8dh421ALn3ALDjH5Dbto8IOAoAQPqGUNtEklbDJb6AIIfXYcYRsH3VB9ozvSYUxfwwVn0CmZiPgkhyFYL3oWACUEwlODYGPOIBSgBhjOu+L9UfCylCPhPapZN6P2h/YEAtl/rlBdwR/qha3iwf/5mgUARXd29sE3cd7BizVkafKuYgiOqr+MWvAdnvIkLXzCf2VLJ3CeTwa8UczdwAm7Ak6wkY9EiZIRxFVcVVR8a44r/rXvtSKYtWIvqqlhQ8bfCrxJr1/QJMM5d3ZMKztBSA1jkwP5nv17an7vv+u5j7kK5AAAAAElFTkSuQmCC\"\r\n     };\r\n\r\n        // Initialize the FullCalendar instance\r\n        var calendar = new FullCalendar.Calendar(calendarEl, {\r\n            initialView: \"timeGridDay\",\r\n            headerToolbar: {\r\n                left: \"prev,next today\",\r\n                center: \"title\",\r\n                right: \"dayGridMonth,timeGridWeek,timeGridDay\"\r\n            },\r\n            dayMaxEvents: true,\r\n            editable: true,\r\n            droppable: true,\r\n            eventContent: function (arg) {\r\n                    if (arg.event.extendedProps.customTitle) {\r\n                        return { html: arg.event.extendedProps.customTitle };\r\n                    }\r\n                },\r\n\r\n            // Event handler for when a job is dragged and dropped onto the calendar\r\n     eventReceive: function(info) {\r\n    let jobId = info.event.id;\r\n    let jobTitle = info.event.title;\r\n    let startDate = info.event.start;\r\n    let endDate = new Date(startDate);\r\n    endDate.setHours(startDate.getHours() + 1);\r\n\r\n    console.log(\"Event Dropped:\", { jobId, jobTitle, startDate, endDate });\r\n\r\n    frappe.call({\r\n        method: \"frappe.poc.api.insert_testingcal_event\",\r\n        args: {\r\n            job_id: info.event.id,\r\n            job_title: info.event.title,\r\n            start_date: info.event.start.toISOString(),\r\n        },\r\n        callback: function(response) {\r\n            if (response.message) {\r\n                let e = response.message;\r\n                Create=true;\r\n                console.log(\"Frappe Response:\", e);\r\n                       info.event.setProp('id', e.name);\r\n            }\r\n        },\r\n        error: function(error) {\r\n            console.error(\"Error inserting event:\", error);\r\n        }\r\n    });\r\n},\r\n\r\n\r\neventChange: function (info) {\r\n    if (isUpdatingEvent) {\r\n        // Skip if an update is already in progress to prevent infinite loop\r\n        return;\r\n    }\r\n\r\n    let updatedStartDate = info.event.start;\r\n    let updatedEndDate = info.event.end;\r\n\r\n    // Ensure event has an ID\r\n    if (!info.event.id) {\r\n        console.error(\"Event ID is missing.\");\r\n        return;\r\n    }\r\n\r\n    isUpdatingEvent = true; // Set flag to indicate an update is in progress\r\n\r\n    // Fetch the latest document before updating\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"testingcal\",\r\n            name: info.event.id\r\n        },\r\n        callback: async function (docResponse) {\r\n            if (!docResponse.message) {\r\n                console.error(\"Failed to fetch event data.\");\r\n                isUpdatingEvent = false;\r\n                return;\r\n            }\r\n            let newJobTitleHtml = \"\";\r\n\r\n           \r\n                let startTime = new Date(updatedStartDate);\r\n                let endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // Add 1 hour\r\n                \r\n                // Format the times\r\n                startTime = startTime.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n                endTime = endTime.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n\r\n                // Fetch product name from SalesPoc\r\n                const getproduct_name = docResponse.message.title ? await gettitle(docResponse.message.title) : \"Unknown Product\";\r\n\r\n                // Fetch full names for technicians\r\n                const technicianNames = docResponse.message.technicians\r\n                    ? await Promise.all(docResponse.message.technicians.map(tech => getUserFullName(tech.user)))\r\n                    : [];\r\n\r\n                // Fetch vehicle names\r\n                const vehicleNames = docResponse.message.vehicles\r\n                    ? await Promise.all(docResponse.message.vehicles.map(vehi => getVehicleName(vehi.vehicle)))\r\n                    : [];\r\n\r\n                // Construct job title with time and details\r\n                newJobTitleHtml = `\r\n                    <div>\r\n                        <strong>${startTime} - ${endTime}</strong><br>\r\n                        <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                        ${technicianNames.length ? `<img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>` : \"\"}\r\n                        ${vehicleNames.length ? `<img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>` : \"\"}\r\n                    </div>\r\n                `;\r\n\r\n                // Update event UI, and ensure this doesn't trigger another eventChange\r\n                info.event.setExtendedProp(\"customTitle\", newJobTitleHtml);\r\n                if(Create){\r\n                 isUpdatingEvent = false;\r\n                 Create=false;\r\n                 return;\r\n                }\r\n            \r\n\r\n            let doc = docResponse.message; // Latest document\r\n\r\n            // Update fields\r\n            doc.startdate = formatDateForMySQL(updatedStartDate);\r\n            doc.end_date = formatDateForMySQL(updatedEndDate);\r\n\r\n            // Save the updated document\r\n            frappe.call({\r\n                method: \"frappe.client.save\",\r\n                args: {\r\n                    doc: doc\r\n                },\r\n                callback: async function (saveResponse) {\r\n                    if (!saveResponse.message) {\r\n                        console.error(\"Failed to save updated event.\");\r\n                        isUpdatingEvent = false;\r\n                        return;\r\n                    }\r\n\r\n                    console.log(\"Updated Event:\", saveResponse.message);\r\n\r\n                    let newJobTitleHtml = \"\";\r\n\r\n                    // Format time (Start - End)\r\n                    let startTime = new Date(doc.startdate).toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n                    let endTime = new Date(doc.end_date).toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n\r\n                    // Fetch product name from SalesPoc\r\n                    const getproduct_name = doc.title ? await gettitle(doc.title) : \"Unknown Product\";\r\n\r\n                    // Fetch full names for technicians\r\n                    const technicianNames = doc.technicians\r\n                        ? await Promise.all(doc.technicians.map(tech => getUserFullName(tech.user)))\r\n                        : [];\r\n\r\n                    // Fetch vehicle names\r\n                    const vehicleNames = doc.vehicles\r\n                        ? await Promise.all(doc.vehicles.map(vehi => getVehicleName(vehi.vehicle)))\r\n                        : [];\r\n\r\n                    // Construct job title with time and details\r\n                    newJobTitleHtml = `\r\n                        <div>\r\n                            <strong>${startTime} - ${endTime}</strong><br>\r\n                            <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                            ${technicianNames.length ? `<img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>` : \"\"}\r\n                            ${vehicleNames.length ? `<img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>` : \"\"}\r\n                        </div>\r\n                    `;\r\n\r\n                    // Update event UI, and ensure this doesn't trigger another eventChange\r\n                    info.event.setExtendedProp(\"customTitle\", newJobTitleHtml);\r\n\r\n                    console.log(\"Event Updated Successfully!\");\r\n\r\n                    // Reset the flag after update\r\n                    isUpdatingEvent = false;\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n},\r\n\r\n    eventClick: function(info) {\r\n        if (info.event.id) {\r\n             window.open(\"http://localhost:8081/app/testingcal/\" + info.event.id, \"_blank\");// Redirect to event details page\r\n         console.log(info.event.id);\r\n         \r\n                         }\r\n           },\r\n            eventRender: function(info) {\r\n            info.el.setAttribute(\"data-id\", info.event.id);\r\n            }\r\n    \r\n        });\r\n  \r\n        // Render the calendar\r\n        calendar.render();\r\n        \r\n        \r\n\r\n        // Fetch and populate the list of jobs\r\n        function fetchJobs() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"SalesPoc\",\r\n                    filters: { status: \"Accepted\" },\r\n                    fields: [\"name\", \"product_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let jobs = response.message || [];\r\n                    jobListEl.innerHTML = jobs.map(job =>\r\n                        `<li class=\"list-group-item job-item\" data-id=\"${job.name}\" draggable=\"true\">${job.product_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch and populate the list of vehicles\r\n        function fetchVehicles() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Vehicles\",\r\n                    fields: [\"name\", \"vehicle_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let vehicles = response.message || [];\r\n                    vehicleListEl.innerHTML = vehicles.map(v =>\r\n                        `<li class=\"list-group-item vehicle-item\" data-id=\"${v.name}\" draggable=\"true\">${v.vehicle_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch and populate the list of users\r\n        function fetchUsers() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"User\",\r\n                    filters: { role_profile_name: \"EnigneerPOC\" }, // Note: There's a typo here, \"Enigneer\" should be \"Engineer\"\r\n                    fields: [\"name\", \"full_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let users = response.message || [];\r\n                    userListEl.innerHTML = users.map(u =>\r\n                        `<li class=\"list-group-item user-item\" data-id=\"${u.name}\" draggable=\"true\">${u.full_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch existing events from the calendar and display them\r\nfunction fetchCalendarEvents() {\r\n    frappe.call({\r\n        method: \"frappe.poc.api.get_testingcal_events\",\r\n        callback: async function (response) {\r\n            let events = response.message ? response.message.map(e => {\r\n                let startTime = new Date(e.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                let endTime = new Date(e.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                let newJobTitleHtml = `<div>${startTime} - ${endTime}<br>`;  // Show time at top\r\n                    newJobTitleHtml +=  `<div><img src=\"${images.jobicon}\" width=\"15\"> ${e.product_name || e.name}<br>`;\r\n\r\n                if (e.technicians.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.techniciansicon}\" width=\"15\"> ${e.technicians.join(\", \")}<br>`;\r\n                }\r\n                if (e.vehicles.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.vechicleicon}\" width=\"15\"> ${e.vehicles.join(\", \")}<br>`;\r\n                }\r\n\r\n                newJobTitleHtml += `</div>`;\r\n\r\n                return {\r\n                    id: e.name,\r\n                    title: e.jobtitle,\r\n                    start: e.startdate,\r\n                    end: e.end_date,\r\n                    extendedProps: { customTitle: newJobTitleHtml }\r\n                };\r\n            }) : [];\r\n\r\n            calendar.removeAllEvents();\r\n            calendar.addEventSource(events);\r\n            console.log(events);\r\n        }\r\n    });\r\n}\r\nasync function getUserFullName(userId) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"User\",\r\n                filters: { name: userId },\r\n                fieldname: \"full_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.full_name || \"Unknown User\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\nasync function gettitle(title) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"SalesPoc\",\r\n                filters: { name: title },\r\n                fieldname: \"product_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.product_name || \"Unknown product\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\n// Function to fetch vehicle name\r\nasync function getVehicleName(vehicleId) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"Vehicles\",\r\n                filters: { name: vehicleId },\r\n                fieldname: \"vehicle_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.vehicle_name || \"Unknown Vehicle\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\n        // Function to make list items (jobs, users, vehicles) draggable\r\n        function makeDraggable() {\r\n            new FullCalendar.Draggable(jobListEl, {\r\n                itemSelector: \".job-item\",\r\n                eventData: function (eventEl) {\r\n                    return { id: eventEl.getAttribute(\"data-id\"), title: eventEl.innerText };\r\n                }\r\n            });\r\n\r\n            // Set up drag-and-drop for users\r\n            document.getElementById(\"user-list\").addEventListener(\"dragstart\", function (event) {\r\n                event.dataTransfer.setData(\"text/plain\", JSON.stringify({\r\n                    id: event.target.getAttribute(\"data-id\"),\r\n                    name: event.target.innerText,\r\n                    type: \"assigned\"  // Assigning user data\r\n                }));\r\n            });\r\n\r\n            // Set up drag-and-drop for vehicles\r\n            document.getElementById(\"vehicle-list\").addEventListener(\"dragstart\", function (event) {\r\n                event.dataTransfer.setData(\"text/plain\", JSON.stringify({\r\n                    id: event.target.getAttribute(\"data-id\"),\r\n                    name: event.target.innerText,\r\n                    type: \"vehicle\"  // Assigning vehicle data\r\n                }));\r\n            });\r\n            \r\n\r\n            // Allow drag over the calendar (enabling drop)\r\n            calendarEl.addEventListener(\"dragover\", function (event) {\r\n                event.preventDefault();\r\n            });\r\n\r\n        }\r\n          \r\n    document.getElementById(\"calendar\").addEventListener(\"drop\", async function (event) {\r\n    event.preventDefault();\r\n\r\n    let GetUserorvehicleData = JSON.parse(event.dataTransfer.getData(\"text/plain\")),\r\n        jobElement = document.elementFromPoint(event.clientX, event.clientY)?.closest(\".fc-event\");\r\n\r\n    if (!jobElement) return;\r\n\r\n    let jobId = jobElement.getAttribute(\"data-id\") || jobElement.fcSeg.eventRange.def.publicId,\r\n        calendarEvent = calendar.getEventById(jobId),\r\n        JobOriginalContent = jobElement.fcSeg.eventRange.def.extendedProps.JobTitle,\r\n        currentTitle = calendarEvent ? calendarEvent.title : JobOriginalContent,\r\n        newJobTitle = `${currentTitle} ${GetUserorvehicleData.name}`;\r\n\r\n    // Determine fields dynamically\r\n    let isVehicle = GetUserorvehicleData.type === \"vehicle\",\r\n        fieldName = isVehicle ? \"vehicles\" : \"technicians\",\r\n        singleField = isVehicle ? \"vehicle\" : \"assigned\",\r\n        childDocType = isVehicle ? \"childdoc\" : \"Userchild\",\r\n        userField = isVehicle ? \"vehicle\" : \"user\"; // Fix: Vehicles should store \"vehicle\"\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: { doctype: \"testingcal\", name: jobId },\r\n        callback: async function (response) {\r\n            if (!response.message) return;\r\n\r\n            let existingEntries = response.message[fieldName] || [];\r\n            if (existingEntries.some(e => e[userField] === GetUserorvehicleData.id)) {\r\n                return frappe.msgprint(`${GetUserorvehicleData.type} already assigned!`);\r\n            }\r\n\r\n            existingEntries.push({ \"doctype\": childDocType, [userField]: GetUserorvehicleData.id });\r\n\r\n            // Update the job in the database with the new job title, user/vehicle assignment, and other necessary fields\r\n            frappe.call({\r\n                method: \"frappe.client.set_value\",\r\n                args: {\r\n                    doctype: \"testingcal\",\r\n                    name: jobId,\r\n                    fieldname: {\r\n                        [singleField]: GetUserorvehicleData.id,\r\n                        [fieldName]: existingEntries,\r\n                        jobtitle: newJobTitle // Update the title in the database\r\n                    }\r\n                },\r\n                callback: async function (response) {\r\n                    console.log(`Updated Job with ${GetUserorvehicleData.type}:`, response.message);\r\n\r\n                    let newJobTitleHtml = \"\";\r\n                    \r\n                    // Format time (Start - End)\r\n                    let startTime = new Date(response.message.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                    let endTime = new Date(response.message.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                    \r\n                    // Fetch full names for technicians\r\n                    const technicianNames = await Promise.all(\r\n                        response.message.technicians.map(tech => getUserFullName(tech.user))\r\n                    );\r\n                    \r\n                    const getproduct_name = await gettitle(response.message.title);\r\n                    // Fetch vehicle names\r\n                    const vehicleNames = await Promise.all(\r\n                        response.message.vehicles.map(vehi => getVehicleName(vehi.vehicle))\r\n                    );\r\n                    \r\n                    // Construct job title with time and details\r\n                    if (technicianNames.length !== 0 && vehicleNames.length !== 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>\r\n                                <img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    else if (technicianNames.length !== 0 && vehicleNames.length == 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    else if (vehicleNames.length !== 0 && technicianNames.length == 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    \r\n                    frappe.msgprint(`${GetUserorvehicleData.type} Added: ${GetUserorvehicleData.name}`);\r\n                    \r\n                    // Store updated job details with time in `extendedProps`\r\n                    calendarEvent?.setExtendedProp('customTitle', newJobTitleHtml);\r\n\r\n                }\r\n            });\r\n        }\r\n    });\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n        //Date and time formating\r\n          function formatDateForMySQL(date) {\r\n                    return date.getFullYear() + \"-\" +\r\n                        (\"0\" + (date.getMonth() + 1)).slice(-2) + \"-\" +\r\n                        (\"0\" + date.getDate()).slice(-2) + \" \" +\r\n                        (\"0\" + date.getHours()).slice(-2) + \":\" +\r\n                        (\"0\" + date.getMinutes()).slice(-2) + \":\" +\r\n                        (\"0\" + date.getSeconds()).slice(-2);\r\n                }\r\n\r\n        // Initialize everything by fetching data and making elements draggable\r\n        fetchJobs();\r\n        fetchVehicles();\r\n        fetchUsers();\r\n        fetchCalendarEvents();\r\n        makeDraggable();\r\n    });\r\n });\r\n</script>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 12:06:58.368842",
  "module": "Poova",
  "name": "calendarpage",
  "page_blocks": [],
  "published": 1,
  "route": "calendarpage",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "calendarpage",
  "website_sidebar": null
 },
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 0,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!-- Load FullCalendar CSS -->\r\n<link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css\" rel=\"stylesheet\">\r\n\r\n<!-- Load FullCalendar JS -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js\"></script>\r\n\r\n<div class=\"row\">\r\n    <!-- Jobs List Section -->\r\n    <div class=\"col-md-3\">\r\n        <h3>Jobs</h3>\r\n        <ul id=\"job-list\" class=\"list-group mt-2\"></ul>\r\n    </div>\r\n\r\n    <!-- Calendar Section -->\r\n    <div class=\"col-md-6\">\r\n        <div id=\"calendar\"></div>\r\n    </div>\r\n\r\n    <!-- Vehicle and User List Section -->\r\n    <div class=\"col-md-3\">\r\n        <h3>Vehicle</h3>\r\n        <ul id=\"vehicle-list\" class=\"list-group mt-2\"></ul>\r\n        <h3>Technicians</h3>\r\n        <ul id=\"user-list\" class=\"list-group mt-2\"></ul>\r\n    </div>\r\n</div>\r\n<style>\r\n    html, body {\r\n  margin: 0;\r\n  padding: 0;\r\n  font-family: Arial, Helvetica Neue, Helvetica, sans-serif;\r\n  font-size: 14px;\r\n}\r\n\r\n#calendar {\r\n  max-width: 800px;\r\n  margin: 40px auto;\r\n}\r\n#job-list, #vehicle-list, #user-list {\r\n    height: 30vh;\r\n    overflow-y: scroll;\r\n    scrollbar-width: none;\r\n    list-style-type: none;\r\n    padding-left: 0;\r\n}\r\n#job-list{height:60vh!important}\r\n.web-footer{display:none}\r\n\r\n.sortable-ghost { opacity: 0.4; }\r\n.fc-event { cursor: pointer; }\r\n</style>\r\n<script>\r\n document.addEventListener('DOMContentLoaded', function() {\r\n frappe.ready(function () {\r\n        var calendarEl = document.getElementById(\"calendar\");\r\n        var jobListEl = document.getElementById(\"job-list\");\r\n        var vehicleListEl = document.getElementById(\"vehicle-list\");\r\n        var userListEl = document.getElementById(\"user-list\");\r\n        let isUpdatingEvent = false; \r\n        let Create=false;\r\n           const images = {\r\n          jobicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABtUlEQVR4Aa1Wi3GDMAw1vQzABvEIjMAGZYNkg9AJwgZhA7pBukFGoBvQTuBuoErJc1Acm7i56k6HbX2efhgKk0FE1PDjVR39FEXxlmP7YvKoYm6wtswtg67NM8SGO+HgbGD+wNrShWolt9Cxj5zvaSZZS6Qn7HvolEpHnG6ZJ+ynJIhy3jFXysiF0cHpqIDeYTMmQVSkpUp76/eJoGoMgN+38NHElC3Qx4hsg0ymqPFsLzqdWYhoQARVcN6gDJ42EVsvXy8BSIST2peBvEuBoJx0lwGaI7U8QKFVUZ8SQXiqA5kD12DrDwmGJ8IE0Nz0jXJg6ZaGAKCFH3eVR9MyNxNBWNdB9NdsE+U+j/cqpcB3TY8e7JkPCbXkCIdIvkQjLTc2RrqEu1iJLNLvFsqVBcLPIwAa+Cxj2TiKvL2kJoNu34krCGTVUrl6KD+8ilMgSwb+quhMJv0JhC4Ndmov5ZDxtP8CQvPc71FPTQPdX9dH1dxsED0tPc1v5hkEOv6DI8PQPptJGymDB6hgXGWUy5kcQmYOZfFfsnVCV4N0K5NH8sH3Dj+F+Sr5jinyufTny1x+bfpffZT/wwL3joQAAAAASUVORK5CYII=\",\r\n          techniciansicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAPCAYAAAD+pA/bAAAAyElEQVR4AbWSDQ3CMBCFr1MwHNQBlVAJSMABOGAOkIAEJFQCOBgONhSUu+RK1nJ0TTi+5KU/ad/rNQfQQIzxHHOOoAkajkVAaL3bVUw9ag/14MPaGemSpRfySydUL1XA5xJXWreal2bDl4BLsTeuhghGqYpJMJO41cxPUYdh6WuWr8fBwu/MxphNWnRs7pXMCWoKlwUgDnT5COhBF/ueYTk7oUs08CkgxP8Q0hdpf0/2TYarcLxB45ZDS5XMLOLBeqLuJGxVGuEFaLkGQweqVP8AAAAASUVORK5CYII=\",\r\n          vechicleicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAUCAYAAACXtf2DAAABFElEQVR4Ad1U2w3CMAx0EAN0hIwAG8AGjMAGiAmACRATwAawAWxAmaBlgrJBuKiOsIJpEWl/OOkaNXZ8dh421ALn3ALDjH5Dbto8IOAoAQPqGUNtEklbDJb6AIIfXYcYRsH3VB9ozvSYUxfwwVn0CmZiPgkhyFYL3oWACUEwlODYGPOIBSgBhjOu+L9UfCylCPhPapZN6P2h/YEAtl/rlBdwR/qha3iwf/5mgUARXd29sE3cd7BizVkafKuYgiOqr+MWvAdnvIkLXzCf2VLJ3CeTwa8UczdwAm7Ak6wkY9EiZIRxFVcVVR8a44r/rXvtSKYtWIvqqlhQ8bfCrxJr1/QJMM5d3ZMKztBSA1jkwP5nv17an7vv+u5j7kK5AAAAAElFTkSuQmCC\"\r\n     };\r\n\r\n        // Initialize the FullCalendar instance\r\n        var calendar = new FullCalendar.Calendar(calendarEl, {\r\n            initialView: \"timeGridDay\",\r\n            headerToolbar: {\r\n                left: \"prev,next today\",\r\n                center: \"title\",\r\n                right: \"dayGridMonth,timeGridWeek,timeGridDay\"\r\n            },\r\n            dayMaxEvents: true,\r\n            editable: true,\r\n            droppable: true,\r\n            eventContent: function (arg) {\r\n                    if (arg.event.extendedProps.customTitle) {\r\n                        return { html: arg.event.extendedProps.customTitle };\r\n                    }\r\n                },\r\n\r\n            // Event handler for when a job is dragged and dropped onto the calendar\r\n     eventReceive: function(info) {\r\n    let jobId = info.event.id;\r\n    let jobTitle = info.event.title;\r\n    let startDate = info.event.start;\r\n    let endDate = new Date(startDate);\r\n    endDate.setHours(startDate.getHours() + 1);\r\n\r\n    console.log(\"Event Dropped:\", { jobId, jobTitle, startDate, endDate });\r\n\r\n    frappe.call({\r\n        method: \"frappe.poc.api.insert_testingcal_event\",\r\n        args: {\r\n            job_id: info.event.id,\r\n            job_title: info.event.title,\r\n            start_date: info.event.start.toISOString(),\r\n        },\r\n        callback: function(response) {\r\n            if (response.message) {\r\n                let e = response.message;\r\n                Create=true;\r\n                console.log(\"Frappe Response:\", e);\r\n                       info.event.setProp('id', e.name);\r\n            }\r\n        },\r\n        error: function(error) {\r\n            console.error(\"Error inserting event:\", error);\r\n        }\r\n    });\r\n},\r\n\r\n\r\neventChange: function (info) {\r\n    if (isUpdatingEvent) {\r\n        // Skip if an update is already in progress to prevent infinite loop\r\n        return;\r\n    }\r\n\r\n    let updatedStartDate = info.event.start;\r\n    let updatedEndDate = info.event.end;\r\n\r\n    // Ensure event has an ID\r\n    if (!info.event.id) {\r\n        console.error(\"Event ID is missing.\");\r\n        return;\r\n    }\r\n\r\n    isUpdatingEvent = true; // Set flag to indicate an update is in progress\r\n\r\n    // Fetch the latest document before updating\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: {\r\n            doctype: \"testingcal\",\r\n            name: info.event.id\r\n        },\r\n        callback: async function (docResponse) {\r\n            if (!docResponse.message) {\r\n                console.error(\"Failed to fetch event data.\");\r\n                isUpdatingEvent = false;\r\n                return;\r\n            }\r\n            let newJobTitleHtml = \"\";\r\n\r\n           \r\n                let startTime = new Date(updatedStartDate);\r\n                let endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // Add 1 hour\r\n                \r\n                // Format the times\r\n                startTime = startTime.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n                endTime = endTime.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n\r\n                // Fetch product name from SalesPoc\r\n                const getproduct_name = docResponse.message.title ? await gettitle(docResponse.message.title) : \"Unknown Product\";\r\n\r\n                // Fetch full names for technicians\r\n                const technicianNames = docResponse.message.technicians\r\n                    ? await Promise.all(docResponse.message.technicians.map(tech => getUserFullName(tech.user)))\r\n                    : [];\r\n\r\n                // Fetch vehicle names\r\n                const vehicleNames = docResponse.message.vehicles\r\n                    ? await Promise.all(docResponse.message.vehicles.map(vehi => getVehicleName(vehi.vehicle)))\r\n                    : [];\r\n\r\n                // Construct job title with time and details\r\n                newJobTitleHtml = `\r\n                    <div>\r\n                        <strong>${startTime} - ${endTime}</strong><br>\r\n                        <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                        ${technicianNames.length ? `<img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>` : \"\"}\r\n                        ${vehicleNames.length ? `<img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>` : \"\"}\r\n                    </div>\r\n                `;\r\n\r\n                // Update event UI, and ensure this doesn't trigger another eventChange\r\n                info.event.setExtendedProp(\"customTitle\", newJobTitleHtml);\r\n                if(Create){\r\n                 isUpdatingEvent = false;\r\n                 Create=false;\r\n                 return;\r\n                }\r\n            \r\n\r\n            let doc = docResponse.message; // Latest document\r\n\r\n            // Update fields\r\n            doc.startdate = formatDateForMySQL(updatedStartDate);\r\n            doc.end_date = formatDateForMySQL(updatedEndDate);\r\n\r\n            // Save the updated document\r\n            frappe.call({\r\n                method: \"frappe.client.save\",\r\n                args: {\r\n                    doc: doc\r\n                },\r\n                callback: async function (saveResponse) {\r\n                    if (!saveResponse.message) {\r\n                        console.error(\"Failed to save updated event.\");\r\n                        isUpdatingEvent = false;\r\n                        return;\r\n                    }\r\n\r\n                    console.log(\"Updated Event:\", saveResponse.message);\r\n\r\n                    let newJobTitleHtml = \"\";\r\n\r\n                    // Format time (Start - End)\r\n                    let startTime = new Date(doc.startdate).toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n                    let endTime = new Date(doc.end_date).toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" });\r\n\r\n                    // Fetch product name from SalesPoc\r\n                    const getproduct_name = doc.title ? await gettitle(doc.title) : \"Unknown Product\";\r\n\r\n                    // Fetch full names for technicians\r\n                    const technicianNames = doc.technicians\r\n                        ? await Promise.all(doc.technicians.map(tech => getUserFullName(tech.user)))\r\n                        : [];\r\n\r\n                    // Fetch vehicle names\r\n                    const vehicleNames = doc.vehicles\r\n                        ? await Promise.all(doc.vehicles.map(vehi => getVehicleName(vehi.vehicle)))\r\n                        : [];\r\n\r\n                    // Construct job title with time and details\r\n                    newJobTitleHtml = `\r\n                        <div>\r\n                            <strong>${startTime} - ${endTime}</strong><br>\r\n                            <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                            ${technicianNames.length ? `<img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>` : \"\"}\r\n                            ${vehicleNames.length ? `<img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>` : \"\"}\r\n                        </div>\r\n                    `;\r\n\r\n                    // Update event UI, and ensure this doesn't trigger another eventChange\r\n                    info.event.setExtendedProp(\"customTitle\", newJobTitleHtml);\r\n\r\n                    console.log(\"Event Updated Successfully!\");\r\n\r\n                    // Reset the flag after update\r\n                    isUpdatingEvent = false;\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n},\r\n\r\n    eventClick: function(info) {\r\n        if (info.event.id) {\r\n             window.open(\"http://localhost:8081/app/testingcal/\" + info.event.id, \"_blank\");// Redirect to event details page\r\n         console.log(info.event.id);\r\n         \r\n                         }\r\n           },\r\n            eventRender: function(info) {\r\n            info.el.setAttribute(\"data-id\", info.event.id);\r\n            }\r\n    \r\n        });\r\n  \r\n        // Render the calendar\r\n        calendar.render();\r\n        \r\n        \r\n\r\n        // Fetch and populate the list of jobs\r\n        function fetchJobs() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"SalesPoc\",\r\n                    filters: { status: \"Accepted\" },\r\n                    fields: [\"name\", \"product_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let jobs = response.message || [];\r\n                    jobListEl.innerHTML = jobs.map(job =>\r\n                        `<li class=\"list-group-item job-item\" data-id=\"${job.name}\" draggable=\"true\">${job.product_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch and populate the list of vehicles\r\n        function fetchVehicles() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"Vehicles\",\r\n                    fields: [\"name\", \"vehicle_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let vehicles = response.message || [];\r\n                    vehicleListEl.innerHTML = vehicles.map(v =>\r\n                        `<li class=\"list-group-item vehicle-item\" data-id=\"${v.name}\" draggable=\"true\">${v.vehicle_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch and populate the list of users\r\n        function fetchUsers() {\r\n            frappe.call({\r\n                method: \"frappe.client.get_list\",\r\n                args: {\r\n                    doctype: \"User\",\r\n                    filters: { role_profile_name: \"EnigneerPOC\" }, // Note: There's a typo here, \"Enigneer\" should be \"Engineer\"\r\n                    fields: [\"name\", \"full_name\"],\r\n                    limit_page_length: 100\r\n                },\r\n                callback: function(response) {\r\n                    let users = response.message || [];\r\n                    userListEl.innerHTML = users.map(u =>\r\n                        `<li class=\"list-group-item user-item\" data-id=\"${u.name}\" draggable=\"true\">${u.full_name}</li>`\r\n                    ).join(\"\");\r\n                }\r\n            });\r\n        }\r\n\r\n        // Fetch existing events from the calendar and display them\r\nfunction fetchCalendarEvents() {\r\n    frappe.call({\r\n        method: \"frappe.poc.api.get_testingcal_events\",\r\n        callback: async function (response) {\r\n            let events = response.message ? response.message.map(e => {\r\n                let startTime = new Date(e.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                let endTime = new Date(e.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                let newJobTitleHtml = `<div>${startTime} - ${endTime}<br>`;  // Show time at top\r\n                    newJobTitleHtml +=  `<div><img src=\"${images.jobicon}\" width=\"15\"> ${e.product_name || e.name}<br>`;\r\n\r\n                if (e.technicians.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.techniciansicon}\" width=\"15\"> ${e.technicians.join(\", \")}<br>`;\r\n                }\r\n                if (e.vehicles.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.vechicleicon}\" width=\"15\"> ${e.vehicles.join(\", \")}<br>`;\r\n                }\r\n\r\n                newJobTitleHtml += `</div>`;\r\n\r\n                return {\r\n                    id: e.name,\r\n                    title: e.jobtitle,\r\n                    start: e.startdate,\r\n                    end: e.end_date,\r\n                    extendedProps: { customTitle: newJobTitleHtml }\r\n                };\r\n            }) : [];\r\n\r\n            calendar.removeAllEvents();\r\n            calendar.addEventSource(events);\r\n            console.log(events);\r\n        }\r\n    });\r\n}\r\nasync function getUserFullName(userId) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"User\",\r\n                filters: { name: userId },\r\n                fieldname: \"full_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.full_name || \"Unknown User\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\nasync function gettitle(title) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"SalesPoc\",\r\n                filters: { name: title },\r\n                fieldname: \"product_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.product_name || \"Unknown product\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\n// Function to fetch vehicle name\r\nasync function getVehicleName(vehicleId) {\r\n    return new Promise((resolve) => {\r\n        frappe.call({\r\n            method: \"frappe.client.get_value\",\r\n            args: {\r\n                doctype: \"Vehicles\",\r\n                filters: { name: vehicleId },\r\n                fieldname: \"vehicle_name\"\r\n            },\r\n            callback: function (res) {\r\n                resolve(res?.message?.vehicle_name || \"Unknown Vehicle\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n\r\n        // Function to make list items (jobs, users, vehicles) draggable\r\n        function makeDraggable() {\r\n            new FullCalendar.Draggable(jobListEl, {\r\n                itemSelector: \".job-item\",\r\n                eventData: function (eventEl) {\r\n                    return { id: eventEl.getAttribute(\"data-id\"), title: eventEl.innerText };\r\n                }\r\n            });\r\n\r\n            // Set up drag-and-drop for users\r\n            document.getElementById(\"user-list\").addEventListener(\"dragstart\", function (event) {\r\n                event.dataTransfer.setData(\"text/plain\", JSON.stringify({\r\n                    id: event.target.getAttribute(\"data-id\"),\r\n                    name: event.target.innerText,\r\n                    type: \"assigned\"  // Assigning user data\r\n                }));\r\n            });\r\n\r\n            // Set up drag-and-drop for vehicles\r\n            document.getElementById(\"vehicle-list\").addEventListener(\"dragstart\", function (event) {\r\n                event.dataTransfer.setData(\"text/plain\", JSON.stringify({\r\n                    id: event.target.getAttribute(\"data-id\"),\r\n                    name: event.target.innerText,\r\n                    type: \"vehicle\"  // Assigning vehicle data\r\n                }));\r\n            });\r\n            \r\n\r\n            // Allow drag over the calendar (enabling drop)\r\n            calendarEl.addEventListener(\"dragover\", function (event) {\r\n                event.preventDefault();\r\n            });\r\n\r\n        }\r\n          \r\n    document.getElementById(\"calendar\").addEventListener(\"drop\", async function (event) {\r\n    event.preventDefault();\r\n\r\n    let GetUserorvehicleData = JSON.parse(event.dataTransfer.getData(\"text/plain\")),\r\n        jobElement = document.elementFromPoint(event.clientX, event.clientY)?.closest(\".fc-event\");\r\n\r\n    if (!jobElement) return;\r\n\r\n    let jobId = jobElement.getAttribute(\"data-id\") || jobElement.fcSeg.eventRange.def.publicId,\r\n        calendarEvent = calendar.getEventById(jobId),\r\n        JobOriginalContent = jobElement.fcSeg.eventRange.def.extendedProps.JobTitle,\r\n        currentTitle = calendarEvent ? calendarEvent.title : JobOriginalContent,\r\n        newJobTitle = `${currentTitle} ${GetUserorvehicleData.name}`;\r\n\r\n    // Determine fields dynamically\r\n    let isVehicle = GetUserorvehicleData.type === \"vehicle\",\r\n        fieldName = isVehicle ? \"vehicles\" : \"technicians\",\r\n        singleField = isVehicle ? \"vehicle\" : \"assigned\",\r\n        childDocType = isVehicle ? \"childdoc\" : \"Userchild\",\r\n        userField = isVehicle ? \"vehicle\" : \"user\"; // Fix: Vehicles should store \"vehicle\"\r\n\r\n    frappe.call({\r\n        method: \"frappe.client.get\",\r\n        args: { doctype: \"testingcal\", name: jobId },\r\n        callback: async function (response) {\r\n            if (!response.message) return;\r\n\r\n            let existingEntries = response.message[fieldName] || [];\r\n            if (existingEntries.some(e => e[userField] === GetUserorvehicleData.id)) {\r\n                return frappe.msgprint(`${GetUserorvehicleData.type} already assigned!`);\r\n            }\r\n\r\n            existingEntries.push({ \"doctype\": childDocType, [userField]: GetUserorvehicleData.id });\r\n\r\n            // Update the job in the database with the new job title, user/vehicle assignment, and other necessary fields\r\n            frappe.call({\r\n                method: \"frappe.client.set_value\",\r\n                args: {\r\n                    doctype: \"testingcal\",\r\n                    name: jobId,\r\n                    fieldname: {\r\n                        [singleField]: GetUserorvehicleData.id,\r\n                        [fieldName]: existingEntries,\r\n                        jobtitle: newJobTitle // Update the title in the database\r\n                    }\r\n                },\r\n                callback: async function (response) {\r\n                    console.log(`Updated Job with ${GetUserorvehicleData.type}:`, response.message);\r\n\r\n                    let newJobTitleHtml = \"\";\r\n                    \r\n                    // Format time (Start - End)\r\n                    let startTime = new Date(response.message.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                    let endTime = new Date(response.message.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                    \r\n                    // Fetch full names for technicians\r\n                    const technicianNames = await Promise.all(\r\n                        response.message.technicians.map(tech => getUserFullName(tech.user))\r\n                    );\r\n                    \r\n                    const getproduct_name = await gettitle(response.message.title);\r\n                    // Fetch vehicle names\r\n                    const vehicleNames = await Promise.all(\r\n                        response.message.vehicles.map(vehi => getVehicleName(vehi.vehicle))\r\n                    );\r\n                    \r\n                    // Construct job title with time and details\r\n                    if (technicianNames.length !== 0 && vehicleNames.length !== 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>\r\n                                <img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    else if (technicianNames.length !== 0 && vehicleNames.length == 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.techniciansicon}\" width=\"15\"> ${technicianNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    else if (vehicleNames.length !== 0 && technicianNames.length == 0) {\r\n                        newJobTitleHtml = `\r\n                            <div>\r\n                                <strong>${startTime} - ${endTime}</strong><br>\r\n                                <img src=\"${images.jobicon}\" width=\"15\"> ${getproduct_name}<br>\r\n                                <img src=\"${images.vechicleicon}\" width=\"15\"> ${vehicleNames.join(\", \")}<br>\r\n                            </div>\r\n                        `;\r\n                    }\r\n                    \r\n                    frappe.msgprint(`${GetUserorvehicleData.type} Added: ${GetUserorvehicleData.name}`);\r\n                    \r\n                    // Store updated job details with time in `extendedProps`\r\n                    calendarEvent?.setExtendedProp('customTitle', newJobTitleHtml);\r\n\r\n                }\r\n            });\r\n        }\r\n    });\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n        //Date and time formating\r\n          function formatDateForMySQL(date) {\r\n                    return date.getFullYear() + \"-\" +\r\n                        (\"0\" + (date.getMonth() + 1)).slice(-2) + \"-\" +\r\n                        (\"0\" + date.getDate()).slice(-2) + \" \" +\r\n                        (\"0\" + date.getHours()).slice(-2) + \":\" +\r\n                        (\"0\" + date.getMinutes()).slice(-2) + \":\" +\r\n                        (\"0\" + date.getSeconds()).slice(-2);\r\n                }\r\n\r\n        // Initialize everything by fetching data and making elements draggable\r\n        fetchJobs();\r\n        fetchVehicles();\r\n        fetchUsers();\r\n        fetchCalendarEvents();\r\n        makeDraggable();\r\n    });\r\n });\r\n</script>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 12:07:09.458424",
  "module": "Poova",
  "name": "checkingday",
  "page_blocks": [],
  "published": 1,
  "route": "checkingday",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "checkingday",
  "website_sidebar": null
 },
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 1,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Calendar Page</title>\r\n\r\n    <!-- Load FullCalendar CSS -->\r\n    <link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css\" rel=\"stylesheet\">\r\n\r\n    <!-- Load FullCalendar JS -->\r\n    <script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js\"></script>\r\n\r\n    <style>\r\n        html, body {\r\n            margin: 0;\r\n            padding: 0;\r\n            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;\r\n            font-size: 14px;\r\n        }\r\n\r\n        #calendar {\r\n            max-width: 1200px;\r\n            margin: 40px auto;\r\n        }\r\n\r\n        .web-footer { display: none; }\r\n        .fc-event { cursor: pointer; }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div id=\"calendar\"></div>\r\n\r\n<script>\r\n document.addEventListener('DOMContentLoaded', function() {\r\n frappe.ready(function () {\r\n        var calendarEl = document.getElementById(\"calendar\");\r\n        \r\n        let isUpdatingEvent = false; \r\n        let Create=false;\r\n           const images = {\r\n          jobicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABtUlEQVR4Aa1Wi3GDMAw1vQzABvEIjMAGZYNkg9AJwgZhA7pBukFGoBvQTuBuoErJc1Acm7i56k6HbX2efhgKk0FE1PDjVR39FEXxlmP7YvKoYm6wtswtg67NM8SGO+HgbGD+wNrShWolt9Cxj5zvaSZZS6Qn7HvolEpHnG6ZJ+ynJIhy3jFXysiF0cHpqIDeYTMmQVSkpUp76/eJoGoMgN+38NHElC3Qx4hsg0ymqPFsLzqdWYhoQARVcN6gDJ42EVsvXy8BSIST2peBvEuBoJx0lwGaI7U8QKFVUZ8SQXiqA5kD12DrDwmGJ8IE0Nz0jXJg6ZaGAKCFH3eVR9MyNxNBWNdB9NdsE+U+j/cqpcB3TY8e7JkPCbXkCIdIvkQjLTc2RrqEu1iJLNLvFsqVBcLPIwAa+Cxj2TiKvL2kJoNu34krCGTVUrl6KD+8ilMgSwb+quhMJv0JhC4Ndmov5ZDxtP8CQvPc71FPTQPdX9dH1dxsED0tPc1v5hkEOv6DI8PQPptJGymDB6hgXGWUy5kcQmYOZfFfsnVCV4N0K5NH8sH3Dj+F+Sr5jinyufTny1x+bfpffZT/wwL3joQAAAAASUVORK5CYII=\",\r\n          techniciansicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAPCAYAAAD+pA/bAAAAyElEQVR4AbWSDQ3CMBCFr1MwHNQBlVAJSMABOGAOkIAEJFQCOBgONhSUu+RK1nJ0TTi+5KU/ad/rNQfQQIzxHHOOoAkajkVAaL3bVUw9ag/14MPaGemSpRfySydUL1XA5xJXWreal2bDl4BLsTeuhghGqYpJMJO41cxPUYdh6WuWr8fBwu/MxphNWnRs7pXMCWoKlwUgDnT5COhBF/ueYTk7oUs08CkgxP8Q0hdpf0/2TYarcLxB45ZDS5XMLOLBeqLuJGxVGuEFaLkGQweqVP8AAAAASUVORK5CYII=\",\r\n          vechicleicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAUCAYAAACXtf2DAAABFElEQVR4Ad1U2w3CMAx0EAN0hIwAG8AGjMAGiAmACRATwAawAWxAmaBlgrJBuKiOsIJpEWl/OOkaNXZ8dh421ALn3ALDjH5Dbto8IOAoAQPqGUNtEklbDJb6AIIfXYcYRsH3VB9ozvSYUxfwwVn0CmZiPgkhyFYL3oWACUEwlODYGPOIBSgBhjOu+L9UfCylCPhPapZN6P2h/YEAtl/rlBdwR/qha3iwf/5mgUARXd29sE3cd7BizVkafKuYgiOqr+MWvAdnvIkLXzCf2VLJ3CeTwa8UczdwAm7Ak6wkY9EiZIRxFVcVVR8a44r/rXvtSKYtWIvqqlhQ8bfCrxJr1/QJMM5d3ZMKztBSA1jkwP5nv17an7vv+u5j7kK5AAAAAElFTkSuQmCC\"\r\n     };\r\n\r\n        // Initialize the FullCalendar instance\r\n        var calendar = new FullCalendar.Calendar(calendarEl, {\r\n            initialView: \"timeGridDay\",\r\n            headerToolbar: {\r\n                left: \"prev,next today\",\r\n                center: \"title\",\r\n                right: \"dayGridMonth,timeGridWeek,timeGridDay\"\r\n            },\r\n            editable: true,\r\n            dayMaxEvents: true,\r\n            eventContent: function (arg) {\r\n                    if (arg.event.extendedProps.customTitle) {\r\n                        return { html: arg.event.extendedProps.customTitle };\r\n                    }\r\n                },\r\neventClick: function(info) {\r\n    if (info.event.id) {\r\n        // Fetch details based on the event id\r\n        frappe.call({\r\n            method: \"frappe.poc.api.get_event_details_by_id\",\r\n            args: {\r\n                 event_id: info.event.id    // Event ID to fetch details for\r\n            },\r\n            callback: function(response) {\r\n                // Assuming the response.data has the fields of your Doctype\r\n                const eventData = response.message;\r\n                let technicianNames = eventData.technicians.map(tech => tech.user || tech);\r\n                let vehicleNames = eventData.vehicles.map(vehicle => vehicle.vehicle || vehicle); \r\n                \r\n                let technicianStr = technicianNames.length ? technicianNames.join(\", \") : \"N/A\";\r\n                let vehicleStr = vehicleNames.length ? vehicleNames.join(\", \") : \"N/A\";\r\n                \r\n                 let message = `\r\n                    <b>Product Name:</b> ${eventData.product_name || \"N/A\"}<br>\r\n                    <b>Start Date:</b> ${formatDate(eventData.startdate) || \"N/A\"}<br>\r\n                    <b>End Date:</b> ${formatDate(eventData.end_date) || \"N/A\"}<br>\r\n                    <b>Assigned Technicians:</b>${technicianStr||\"N/A\"}<br>\r\n                    <b>Assigned Vehicles:</b>${vehicleStr||\"N/A\"}<br>\r\n                `;\r\n\r\n                // Show the event details in a message popup\r\n                frappe.msgprint({\r\n                    title: \"Job Details\",\r\n                    message: message,\r\n                    indicator: \"blue\" // Optional: Change color\r\n                });\r\n            },\r\n            error: function(error) {\r\n                console.error(\"Error fetching event details:\", error);\r\n            }\r\n        });\r\n    }\r\n},\r\neventRender: function(info) {\r\n    info.el.setAttribute(\"data-id\", info.event.id);\r\n}\r\n\r\n\r\n\r\n        });\r\n        calendar.render();// Fetch existing events from the calendar and display them\r\n        \r\nfunction fetchCalendarEvents() {\r\n    frappe.call({\r\n        method: \"frappe.client.get_value\",\r\n        args: {\r\n            doctype: \"User\",\r\n            fieldname: \"email\",\r\n            filters: { name: frappe.session.user }\r\n        },\r\n        callback: function (userResponse) {\r\n            if (!userResponse.message) return;\r\n\r\n            let currentUserEmail = userResponse.message.email; // Get current user's email\r\n            console.log(\"Current User Email:\", currentUserEmail); // Debugging\r\n\r\n            frappe.call({\r\n                method: \"frappe.poc.api.get_role_testingcal_events\",\r\n                args: { user_email: currentUserEmail },\r\n                callback: function (response) {\r\n                    if (!response.message || !Array.isArray(response.message)) {\r\n                        console.log(\"No valid events received.\");\r\n                        return;\r\n                    }\r\n            \r\n                     let events = response.message ? response.message.map(e => {\r\n                let startTime = new Date(e.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                let endTime = new Date(e.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                let newJobTitleHtml = `<div>${startTime} - ${endTime}<br>`;  // Show time at top\r\n                    newJobTitleHtml +=  `<div><img src=\"${images.jobicon}\" width=\"15\"> ${e.product_name || e.name}<br>`;\r\n\r\n                if (e.technicians.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.techniciansicon}\" width=\"15\"> ${e.technicians.join(\", \")}<br>`;\r\n                }\r\n                if (e.vehicles.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.vechicleicon}\" width=\"15\"> ${e.vehicles.join(\", \")}<br>`;\r\n                }\r\n\r\n                newJobTitleHtml += `</div>`;\r\n\r\n                return {\r\n                    id: e.name,\r\n                    title: e.jobtitle,\r\n                    start: e.startdate,\r\n                    end: e.end_date,\r\n                    extendedProps: { customTitle: newJobTitleHtml }\r\n                };\r\n            }) : [];\r\n            \r\n                    console.log(\"Final Mapped Events:\", events);\r\n            \r\n                    calendar.removeAllEvents();\r\n                    calendar.addEventSource(events);\r\n                }\r\n            });\r\n            \r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n        fetchCalendarEvents();\r\n        \r\n    });\r\n });\r\n // Helper function to format date to \"DD/MM/YYYY hh:mm A\" format\r\nfunction formatDate(dateString) {\r\n    const options = {\r\n        year: 'numeric',\r\n        month: '2-digit',\r\n        day: '2-digit',\r\n        hour: '2-digit',\r\n        minute: '2-digit',\r\n        hour12: true,  // Ensures 12-hour clock with AM/PM\r\n    };\r\n    const date = new Date(dateString);\r\n    return date.toLocaleString('en-GB', options).replace(',', '');  // Locale 'en-GB' ensures day/month/year format\r\n}\r\n\r\n\r\n</script>\r\n </body>\r\n</html>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 12:06:32.788124",
  "module": "Poova",
  "name": "rolebasedcalendar",
  "page_blocks": [],
  "published": 1,
  "route": "rolebasedcalendar",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "RoleBasedCalendar",
  "website_sidebar": null
 },
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 0,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!-- Load FullCalendar CSS -->\r\n<link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css\" rel=\"stylesheet\">\r\n\r\n<!-- Load FullCalendar JS -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js\"></script>\r\n\r\n<div>\r\n    <div id=\"calendar\"></div>\r\n</div>\r\n<style>\r\n    html, body {\r\n scrollbar-width:none;\r\n  margin: 0;\r\n  padding: 0;\r\n  font-family: Arial, Helvetica Neue, Helvetica, sans-serif;\r\n  font-size: 14px;\r\n}\r\n.navbar,.container,.fc-button-group{\r\n    display:none;\r\n    \r\n}\r\n.fc-button-group{\r\ndisplay:none !important;\r\n    \r\n}\r\n}\r\n#calendar {\r\n  max-width: 1200px;\r\n  margin: 40px auto;\r\n}\r\n\r\n.web-footer,.container{display:none}\r\n\r\n.sortable-ghost { opacity: 0.4; }\r\n.fc-event { cursor: pointer; }\r\n</style>\r\n<script>\r\n document.addEventListener('DOMContentLoaded', function() {\r\n frappe.ready(function () {\r\n        var calendarEl = document.getElementById(\"calendar\");\r\n        \r\n        let isUpdatingEvent = false; \r\n        let Create=false;\r\n           const images = {\r\n          jobicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABtUlEQVR4Aa1Wi3GDMAw1vQzABvEIjMAGZYNkg9AJwgZhA7pBukFGoBvQTuBuoErJc1Acm7i56k6HbX2efhgKk0FE1PDjVR39FEXxlmP7YvKoYm6wtswtg67NM8SGO+HgbGD+wNrShWolt9Cxj5zvaSZZS6Qn7HvolEpHnG6ZJ+ynJIhy3jFXysiF0cHpqIDeYTMmQVSkpUp76/eJoGoMgN+38NHElC3Qx4hsg0ymqPFsLzqdWYhoQARVcN6gDJ42EVsvXy8BSIST2peBvEuBoJx0lwGaI7U8QKFVUZ8SQXiqA5kD12DrDwmGJ8IE0Nz0jXJg6ZaGAKCFH3eVR9MyNxNBWNdB9NdsE+U+j/cqpcB3TY8e7JkPCbXkCIdIvkQjLTc2RrqEu1iJLNLvFsqVBcLPIwAa+Cxj2TiKvL2kJoNu34krCGTVUrl6KD+8ilMgSwb+quhMJv0JhC4Ndmov5ZDxtP8CQvPc71FPTQPdX9dH1dxsED0tPc1v5hkEOv6DI8PQPptJGymDB6hgXGWUy5kcQmYOZfFfsnVCV4N0K5NH8sH3Dj+F+Sr5jinyufTny1x+bfpffZT/wwL3joQAAAAASUVORK5CYII=\",\r\n          techniciansicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAPCAYAAAD+pA/bAAAAyElEQVR4AbWSDQ3CMBCFr1MwHNQBlVAJSMABOGAOkIAEJFQCOBgONhSUu+RK1nJ0TTi+5KU/ad/rNQfQQIzxHHOOoAkajkVAaL3bVUw9ag/14MPaGemSpRfySydUL1XA5xJXWreal2bDl4BLsTeuhghGqYpJMJO41cxPUYdh6WuWr8fBwu/MxphNWnRs7pXMCWoKlwUgDnT5COhBF/ueYTk7oUs08CkgxP8Q0hdpf0/2TYarcLxB45ZDS5XMLOLBeqLuJGxVGuEFaLkGQweqVP8AAAAASUVORK5CYII=\",\r\n          vechicleicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAUCAYAAACXtf2DAAABFElEQVR4Ad1U2w3CMAx0EAN0hIwAG8AGjMAGiAmACRATwAawAWxAmaBlgrJBuKiOsIJpEWl/OOkaNXZ8dh421ALn3ALDjH5Dbto8IOAoAQPqGUNtEklbDJb6AIIfXYcYRsH3VB9ozvSYUxfwwVn0CmZiPgkhyFYL3oWACUEwlODYGPOIBSgBhjOu+L9UfCylCPhPapZN6P2h/YEAtl/rlBdwR/qha3iwf/5mgUARXd29sE3cd7BizVkafKuYgiOqr+MWvAdnvIkLXzCf2VLJ3CeTwa8UczdwAm7Ak6wkY9EiZIRxFVcVVR8a44r/rXvtSKYtWIvqqlhQ8bfCrxJr1/QJMM5d3ZMKztBSA1jkwP5nv17an7vv+u5j7kK5AAAAAElFTkSuQmCC\"\r\n     };\r\n\r\n        // Initialize the FullCalendar instance\r\n        var calendar = new FullCalendar.Calendar(calendarEl, {\r\n            initialView: \"timeGridDay\",\r\n            /*headerToolbar: {\r\n                left: \"prev,next today\",\r\n                center: \"title\",\r\n                right: \"dayGridMonth,timeGridWeek,timeGridDay\"\r\n            },*/\r\n            editable: true,\r\n            dayMaxEvents: true,\r\n            eventContent: function (arg) {\r\n                    if (arg.event.extendedProps.customTitle) {\r\n                        return { html: arg.event.extendedProps.customTitle };\r\n                    }\r\n                },\r\n        });\r\n        calendar.render();// Fetch existing events from the calendar and display them\r\nfunction fetchCalendarEvents() {\r\n    frappe.call({\r\n        method: \"frappe.client.get_value\",\r\n        args: {\r\n            doctype: \"User\",\r\n            fieldname: \"email\",\r\n            filters: { name: frappe.session.user }\r\n        },\r\n        callback: function (userResponse) {\r\n            if (!userResponse.message) return;\r\n\r\n            let currentUserEmail = userResponse.message.email; // Get current user's email\r\n            console.log(\"Current User Email:\", currentUserEmail); // Debugging\r\n\r\n            frappe.call({\r\n                method: \"frappe.poc.api.get_role_testingcal_events\",\r\n                args: { user_email: currentUserEmail },\r\n                callback: function (response) {\r\n                    if (!response.message || !Array.isArray(response.message)) {\r\n                        console.log(\"No valid events received.\");\r\n                        return;\r\n                    }\r\n            \r\n                     let events = response.message ? response.message.map(e => {\r\n                let startTime = new Date(e.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                let endTime = new Date(e.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                let newJobTitleHtml = `<div>${startTime} - ${endTime}<br>`;  // Show time at top\r\n                    newJobTitleHtml +=  `<div><img src=\"${images.jobicon}\" width=\"15\"> ${e.product_name || e.name}<br>`;\r\n\r\n                if (e.technicians.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.techniciansicon}\" width=\"15\"> ${e.technicians.join(\", \")}<br>`;\r\n                }\r\n                if (e.vehicles.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.vechicleicon}\" width=\"15\"> ${e.vehicles.join(\", \")}<br>`;\r\n                }\r\n\r\n                newJobTitleHtml += `</div>`;\r\n\r\n                return {\r\n                    id: e.name,\r\n                    title: e.jobtitle,\r\n                    start: e.startdate,\r\n                    end: e.end_date,\r\n                    extendedProps: { customTitle: newJobTitleHtml }\r\n                };\r\n            }) : [];\r\n            \r\n                    console.log(\"Final Mapped Events:\", events);\r\n            \r\n                    calendar.removeAllEvents();\r\n                    calendar.addEventSource(events);\r\n                }\r\n            });\r\n            \r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n        fetchCalendarEvents();\r\n        \r\n    });\r\n });\r\n</script>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 12:06:43.415146",
  "module": "Poova",
  "name": "dashboardrolebasedcalendar",
  "page_blocks": [],
  "published": 1,
  "route": "dashboardrolebasedcalendar",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "dashboardRolebasedcalendar",
  "website_sidebar": null
 },
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 0,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<!-- Load FullCalendar CSS -->\r\n<link href=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css\" rel=\"stylesheet\">\r\n\r\n<!-- Load FullCalendar JS -->\r\n<script src=\"https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js\"></script>\r\n\r\n<div>\r\n    <div id=\"calendar\"></div>\r\n</div>\r\n<style>\r\n    html, body {\r\n scrollbar-width:none;\r\n  margin: 0;\r\n  padding: 0;\r\n  font-family: Arial, Helvetica Neue, Helvetica, sans-serif;\r\n  font-size: 14px;\r\n}\r\n.navbar,.container,.fc-button-group{\r\n    display:none;\r\n    \r\n}\r\n.fc-button-group{\r\ndisplay:none !important;\r\n    \r\n}\r\n}\r\n#calendar {\r\n  max-width: 1200px;\r\n  margin: 40px auto;\r\n}\r\n\r\n.web-footer,.container{display:none}\r\n\r\n.sortable-ghost { opacity: 0.4; }\r\n.fc-event { cursor: pointer; }\r\n</style>\r\n<script>\r\n document.addEventListener('DOMContentLoaded', function() {\r\n frappe.ready(function () {\r\n        var calendarEl = document.getElementById(\"calendar\");\r\n        \r\n        let isUpdatingEvent = false; \r\n        let Create=false;\r\n           const images = {\r\n          jobicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAABtUlEQVR4Aa1Wi3GDMAw1vQzABvEIjMAGZYNkg9AJwgZhA7pBukFGoBvQTuBuoErJc1Acm7i56k6HbX2efhgKk0FE1PDjVR39FEXxlmP7YvKoYm6wtswtg67NM8SGO+HgbGD+wNrShWolt9Cxj5zvaSZZS6Qn7HvolEpHnG6ZJ+ynJIhy3jFXysiF0cHpqIDeYTMmQVSkpUp76/eJoGoMgN+38NHElC3Qx4hsg0ymqPFsLzqdWYhoQARVcN6gDJ42EVsvXy8BSIST2peBvEuBoJx0lwGaI7U8QKFVUZ8SQXiqA5kD12DrDwmGJ8IE0Nz0jXJg6ZaGAKCFH3eVR9MyNxNBWNdB9NdsE+U+j/cqpcB3TY8e7JkPCbXkCIdIvkQjLTc2RrqEu1iJLNLvFsqVBcLPIwAa+Cxj2TiKvL2kJoNu34krCGTVUrl6KD+8ilMgSwb+quhMJv0JhC4Ndmov5ZDxtP8CQvPc71FPTQPdX9dH1dxsED0tPc1v5hkEOv6DI8PQPptJGymDB6hgXGWUy5kcQmYOZfFfsnVCV4N0K5NH8sH3Dj+F+Sr5jinyufTny1x+bfpffZT/wwL3joQAAAAASUVORK5CYII=\",\r\n          techniciansicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAPCAYAAAD+pA/bAAAAyElEQVR4AbWSDQ3CMBCFr1MwHNQBlVAJSMABOGAOkIAEJFQCOBgONhSUu+RK1nJ0TTi+5KU/ad/rNQfQQIzxHHOOoAkajkVAaL3bVUw9ag/14MPaGemSpRfySydUL1XA5xJXWreal2bDl4BLsTeuhghGqYpJMJO41cxPUYdh6WuWr8fBwu/MxphNWnRs7pXMCWoKlwUgDnT5COhBF/ueYTk7oUs08CkgxP8Q0hdpf0/2TYarcLxB45ZDS5XMLOLBeqLuJGxVGuEFaLkGQweqVP8AAAAASUVORK5CYII=\",\r\n          vechicleicon : \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAUCAYAAACXtf2DAAABFElEQVR4Ad1U2w3CMAx0EAN0hIwAG8AGjMAGiAmACRATwAawAWxAmaBlgrJBuKiOsIJpEWl/OOkaNXZ8dh421ALn3ALDjH5Dbto8IOAoAQPqGUNtEklbDJb6AIIfXYcYRsH3VB9ozvSYUxfwwVn0CmZiPgkhyFYL3oWACUEwlODYGPOIBSgBhjOu+L9UfCylCPhPapZN6P2h/YEAtl/rlBdwR/qha3iwf/5mgUARXd29sE3cd7BizVkafKuYgiOqr+MWvAdnvIkLXzCf2VLJ3CeTwa8UczdwAm7Ak6wkY9EiZIRxFVcVVR8a44r/rXvtSKYtWIvqqlhQ8bfCrxJr1/QJMM5d3ZMKztBSA1jkwP5nv17an7vv+u5j7kK5AAAAAElFTkSuQmCC\"\r\n     };\r\n\r\n        // Initialize the FullCalendar instance\r\n        var calendar = new FullCalendar.Calendar(calendarEl, {\r\n            initialView: \"timeGridDay\",\r\n            /*headerToolbar: {\r\n                left: \"prev,next today\",\r\n                center: \"title\",\r\n                right: \"dayGridMonth,timeGridWeek,timeGridDay\"\r\n            },*/\r\n           // editable: true,\r\n            dayMaxEvents: true,\r\n            eventContent: function (arg) {\r\n                    if (arg.event.extendedProps.customTitle) {\r\n                        return { html: arg.event.extendedProps.customTitle };\r\n                    }\r\n                },\r\n        });\r\n        calendar.render();// Fetch existing events from the calendar and display them\r\nfunction fetchCalendarEvents() {\r\n    frappe.call({\r\n        method: \"frappe.poc.api.get_testingcal_events\",\r\n        callback: async function (response) {\r\n            let events = response.message ? response.message.map(e => {\r\n                let startTime = new Date(e.startdate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n                let endTime = new Date(e.end_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n\r\n                let newJobTitleHtml = `<div>${startTime} - ${endTime}<br>`;  // Show time at top\r\n                    newJobTitleHtml +=  `<div><img src=\"${images.jobicon}\" width=\"15\"> ${e.product_name || e.name}<br>`;\r\n\r\n                if (e.technicians.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.techniciansicon}\" width=\"15\"> ${e.technicians.join(\", \")}<br>`;\r\n                }\r\n                if (e.vehicles.length !== 0) {\r\n                    newJobTitleHtml += `<img src=\"${images.vechicleicon}\" width=\"15\"> ${e.vehicles.join(\", \")}<br>`;\r\n                }\r\n\r\n                newJobTitleHtml += `</div>`;\r\n\r\n                return {\r\n                    id: e.name,\r\n                    title: e.jobtitle,\r\n                    start: e.startdate,\r\n                    end: e.end_date,\r\n                    extendedProps: { customTitle: newJobTitleHtml }\r\n                };\r\n            }) : [];\r\n\r\n            calendar.removeAllEvents();\r\n            calendar.addEventSource(events);\r\n            console.log(events);\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n\r\n        fetchCalendarEvents();\r\n        \r\n    });\r\n });\r\n</script>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 12:06:30.493168",
  "module": "Poova",
  "name": "admindashboardcalendar",
  "page_blocks": [],
  "published": 1,
  "route": "admindashboardcalendar",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "AdminDashboardCalendar",
  "website_sidebar": null
 },
 {
  "breadcrumbs": null,
  "content_type": "HTML",
  "context_script": null,
  "css": null,
  "docstatus": 0,
  "doctype": "Web Page",
  "dynamic_route": 0,
  "dynamic_template": 0,
  "enable_comments": 0,
  "end_date": null,
  "full_width": 1,
  "header": null,
  "insert_style": 0,
  "javascript": null,
  "main_section": null,
  "main_section_html": "<h1>Hello</h1>\n<h5>Checking  fixtures</h5>",
  "main_section_md": null,
  "meta_description": null,
  "meta_image": null,
  "meta_title": null,
  "modified": "2025-04-11 10:16:33.598905",
  "module": "Poova",
  "name": "hello",
  "page_blocks": [],
  "published": 1,
  "route": "hello",
  "show_sidebar": 0,
  "show_title": 0,
  "slideshow": null,
  "start_date": null,
  "text_align": "Left",
  "title": "Hello",
  "website_sidebar": null
 }
]